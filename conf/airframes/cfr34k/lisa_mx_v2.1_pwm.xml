<?xml version="1.0"?>
<!-- this is a custom frame equipped with Lisa/M and generic china pwm motor controllers -->
<airframe name="cfr34k_copter">
  <servos driver="Pwm">
    <servo name="NW" no="0" min="1000" neutral="1170" max="1920"/>
    <servo name="NE" no="1" min="1000" neutral="1170" max="1920"/>
    <servo name="SE" no="2" min="1000" neutral="1170" max="1920"/>
    <servo name="SW" no="3" min="1000" neutral="1170" max="1920"/>
  </servos>

  <command_laws>
    <call fun="motor_mixing_run(autopilot_motors_on, FALSE, values)"/>
    <set servo="NW" value="motor_mixing.commands[MOTOR_FRONT_LEFT]"/>
    <set servo="NE"  value="motor_mixing.commands[MOTOR_FRONT_RIGHT]"/>
    <set servo="SE" value="motor_mixing.commands[MOTOR_BACK_LEFT]"/>
    <set servo="SW"  value="motor_mixing.commands[MOTOR_BACK_RIGHT]"/>
  </command_laws>

  <commands>
    <axis name="PITCH" failsafe_value="0"/>
    <axis name="ROLL" failsafe_value="0"/>
    <axis name="YAW" failsafe_value="0"/>
    <axis name="THRUST" failsafe_value="0"/>
  </commands>

  <section name="MIXING" prefix="MOTOR_MIXING_">
    <!--define name="STOP_MOTOR" value="1000"/-->
    <define name="TRIM_ROLL" value="0"/>
    <define name="TRIM_PITCH" value="0"/>
    <define name="TRIM_YAW" value="0"/>

    <!--
      L   
      |   
    R-+-R
      |   
      L   
    -->
    <!--define name="ROLL_COEF"   value="{  0  ,    0,  256, -256 }"/>
    <define name="PITCH_COEF"  value="{  256, -256,    0,    0 }"/>
    <define name="YAW_COEF"    value="{  256,  256, -256, -256 }"/>
    <define name="THRUST_COEF" value="{  256,  256,  256,  256 }"/-->

    <!--
    L   R
     \ /
      X
     / \
    R   L
    -->
    <!--define name="ROLL_COEF"   value="{  181, -181, -181,  181 }"/>
    <define name="PITCH_COEF"  value="{  181,  181, -181, -181 }"/>
    <define name="YAW_COEF"    value="{  128, -128,  128,  128 }"/>
    <define name="THRUST_COEF" value="{  256,  256,  256,  256 }"/-->

    <define name="TYPE" value="QUAD_X" />
  </section>

  <section name="IMU" prefix="IMU_">
    <define name="GYRO_P_NEUTRAL" value="-61.0"/>
    <define name="GYRO_Q_NEUTRAL" value="-41.5"/>
    <define name="GYRO_R_NEUTRAL" value="8.0"/>
    <define name="GYRO_P_SENS" value="4.355" integer="16"/>
    <define name="GYRO_Q_SENS" value="4.355" integer="16"/>
    <define name="GYRO_R_SENS" value="4.355" integer="16"/>
    <define name="GYRO_PQ_SENS" value="0.0" integer="16"/>
    <define name="GYRO_PR_SENS" value="0.0" integer="16"/>
    <define name="GYRO_QR_SENS" value="0.0" integer="16"/>

    <define name="ACCEL_X_NEUTRAL" value="-5"/>
    <define name="ACCEL_Y_NEUTRAL" value="-1"/>
    <define name="ACCEL_Z_NEUTRAL" value="67"/>
    <define name="ACCEL_X_SENS" value="4.87843621342" integer="16"/>
    <define name="ACCEL_Y_SENS" value="4.90351819521" integer="16"/>
    <define name="ACCEL_Z_SENS" value="4.8766478792" integer="16"/>

    <define name="MAG_X_NEUTRAL" value="242"/>
    <define name="MAG_Y_NEUTRAL" value="25"/>
    <define name="MAG_Z_NEUTRAL" value="-8"/>
    <define name="MAG_X_SENS" value="3.48652385619" integer="16"/>
    <define name="MAG_Y_SENS" value="3.43628851891" integer="16"/>
    <define name="MAG_Z_SENS" value="4.09068605595" integer="16"/>

    <define name="BODY_TO_IMU_PHI"   value="0" unit="deg" />
    <define name="BODY_TO_IMU_THETA" value="0" unit="deg" />
    <!-- old frame: define name="BODY_TO_IMU_PSI" value="RadOfDeg(  -45. )"/ -->
    <!-- current frame: -45 for X cross, 0 for + cross -->
    <define name="BODY_TO_IMU_PSI"   value="-45" unit="deg" />
  </section>

  <section name="AUTOPILOT">
    <define name="MODE_MANUAL" value="AP_MODE_ATTITUDE_DIRECT"/>
    <define name="MODE_AUTO1" value="AP_MODE_ATTITUDE_Z_HOLD"/>
    <define name="MODE_AUTO2" value="AP_MODE_HOVER_Z_HOLD"/>
  </section>

  <section name="BAT">
    <define name="MILLIAMP_AT_FULL_THROTTLE" value="60000"/>
    <!-- Add 0.7V to each value for the safety diode ;-) -->
    <define name="MAX_BAT_LEVEL" value="12.6" unit="V"/> <!-- 12.6V -->
    <define name="LOW_BAT_LEVEL" value="10.4" unit="V"/> <!-- 10.4V -->
    <define name="CRITIC_BAT_LEVEL" value="9.9" unit="V"/> <!-- 9.9V -->
    <define name="CATASTROPHIC_BAT_LEVEL" value="9.3" unit="V"/> <!-- 9.3V -->
  </section>

  <!-- FIXME -->
  <section name="STABILIZATION_RATE" prefix="STABILIZATION_RATE_">
    <define name="SP_MAX_P" value="10000"/>
    <define name="SP_MAX_Q" value="10000"/>
    <define name="SP_MAX_R" value="10000"/>
    <define name="GAIN_P" value="400"/>
    <define name="GAIN_Q" value="400"/>
    <define name="GAIN_R" value="350"/>
  </section>

  <section name="STABILIZATION_ATTITUDE" prefix="STABILIZATION_ATTITUDE_">
    <!-- setpoints -->
    <define name="SP_MAX_PHI" value="45" unit="deg" />
    <define name="SP_MAX_THETA" value="45" unit="deg" />
    <define name="SP_MAX_R" value="90" unit="deg" />
    <define name="DEADBAND_R" value="200"/>
    <define name="DEADBAND_A" value="200"/>
    <define name="DEADBAND_E" value="200"/>
    <!-- reference -->
    <define name="REF_OMEGA_P" value="800" unit="deg/s" />
    <define name="REF_ZETA_P" value="0.85"/>
    <define name="REF_MAX_P" value="400" unit="deg/s" />
    <define name="REF_MAX_PDOT" value="8000" unit="deg/s2" />
    <define name="REF_OMEGA_Q" value="800" unit="deg/s" />
    <define name="REF_ZETA_Q" value="0.85"/>
    <define name="REF_MAX_Q" value="400" unit="deg/s" />
    <define name="REF_MAX_QDOT" value="8000" unit="deg/s2" />
    <define name="REF_OMEGA_R" value="500" unit="deg/s" />
    <define name="REF_ZETA_R" value="0.85"/>
    <define name="REF_MAX_R" value="180" unit="deg/s" />
    <define name="REF_MAX_RDOT" value="1800" unit="deg/s2" />

    <!-- feedback -->
    <!-- TODO: Update for new motors -->
    <define name="PHI_PGAIN"   value="850"/> <!-- neu: 850 -->
    <define name="PHI_DGAIN"   value="450"/> <!-- neu: 600 -->
    <define name="PHI_IGAIN"   value="5"/>
    <define name="THETA_PGAIN" value="850"/> <!-- neu: 850 -->
    <define name="THETA_DGAIN" value="450"/> <!-- neu: 600 -->
    <define name="THETA_IGAIN" value="5"/>
    <define name="PSI_PGAIN"   value="1000"/>
    <define name="PSI_DGAIN"   value="400"/>
    <define name="PSI_IGAIN"   value="5"/>

    <!-- feedforward -->
    <define name="PHI_DDGAIN" value=" 300"/>
    <define name="THETA_DDGAIN" value=" 300"/>
    <define name="PSI_DDGAIN" value=" 300"/>
  </section>

  <!--removed in 5.2 -->
  <!--section name="INS" prefix="INS_">
    <define name="BARO_SENS" value="22.85" integer="16"/>
  </section-->

  <section name="GUIDANCE_V" prefix="GUIDANCE_V_">
    <define name="MIN_ERR_Z" value="POS_BFP_OF_REAL(-10.)"/>
    <define name="MAX_ERR_Z" value="POS_BFP_OF_REAL( 10.)"/>
    <define name="MIN_ERR_ZD" value="SPEED_BFP_OF_REAL(-10.)"/>
    <define name="MAX_ERR_ZD" value="SPEED_BFP_OF_REAL( 10.)"/>
    <define name="MAX_SUM_ERR" value="2000000"/>
    <define name="HOVER_KP" value="50"/>
    <define name="HOVER_KD" value="10"/>
    <define name="HOVER_KI" value="1"/>
    <!-- 1.5m/s for full stick : BOOZ_SPEED_I_OF_F(1.5) / (MAX_PPRZ/2) -->
    <define name="RC_CLIMB_COEF" value="163"/>
    <!-- BOOZ_SPEED_I_OF_F(1.5) * 20% -->
    <define name="RC_CLIMB_DEAD_BAND" value="160000"/>
    <!--define name="INV_M" value ="0.21"/-->
  </section>

  <section name="AHRS" prefix="AHRS_">
    <!--define name="PROPAGATE_FREQUENCY" value="512"/-->
    <!-- Home (TODO: update when used) -->
    <define name="H_X" value=" 0.427611"/>
    <define name="H_Y" value=" 0.016829"/>
    <define name="H_Z" value=" 0.903806"/>
  </section>

  <section name="GUIDANCE_H" prefix="GUIDANCE_H_">
    <define name="PGAIN" value="50"/>
    <define name="DGAIN" value="50"/>
    <define name="IGAIN" value="0"/>
  </section>

  <modules main_freq="512">
    <load name="bat_checker.xml">
      <define name="BAT_CHECKER_DELAY" value="5"/>
      <define name="BAT_CHECKER_LED" value="12"/>
    </load>
    <load name="geo_mag.xml" />
    <load name="send_imu_mag_current.xml" />
  </modules>

  <firmware name="rotorcraft">
    <subsystem name="radio_control" type="spektrum">
      <define name="RADIO_MODE" value="RADIO_AUX1"/>
      <define name="RADIO_KILL_SWITCH" value="RADIO_GEAR"/>
    </subsystem>
    <subsystem name="motor_mixing"/>
    <subsystem name="actuators" type="pwm">
      <define name="SERVO_HZ" value="400"/>
    </subsystem>
    <subsystem name="telemetry" type="transparent"/>
    <define name="USE_ADAPT_HOVER" value="1"/>
    <!--define name="RADIO_CONTROL_SPEKTRUM_SIGNS" value="\{1,1,-1,1,-1,-1,-1,1,1,1,1,1\}"/-->

    <target name="ap" board="lisa_mx_2.1" />
    <target name="nps" board="pc">
      <subsystem name="fdm" type="jspsim"/>
    </target>
    <subsystem name="imu" type="lisa_mx_v2.1" />
    <subsystem name="stabilization" type="int_quat"/>
    <subsystem name="ahrs" type="int_cmpl_quat" />
    <subsystem name="ins"/>
    <subsystem name="gps" type="ublox">
      <configure name="GPS_BAUD" value="B57600" />
    </subsystem>
  </firmware>
</airframe>
